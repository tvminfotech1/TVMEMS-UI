<div *ngIf="isUser" class="banner">
  Your WFH Request Eligibility has been removed. Please reach
  <a href="mailto:wfm@sensiple.com">wfmsensiple.com</a> for more details.
</div>

<div class="WFH-container">
  <div class="header" *ngIf="isUser">
    <button class="addwfh" type="submit" mat-raised-button color="primary" (click)="applyWfh()">
      <mat-icon>add</mat-icon> Apply Work From Home
    </button>
  </div>

  <div *ngIf="showApplyForm" class="overlay" (click)="onFormCancelled()">
    <div class="popup-content" (click)="$event.stopPropagation()">
      <app-wfh-apply-form (formSubmitted)="onFormSubmitted($event)" (formCancelled)="onFormCancelled()">
      </app-wfh-apply-form>
    </div>
  </div>

  <div *ngIf="isUser" class="month-nav">
    <button (click)="prevMonth()">&#60;</button>
    <span class="calendar-icon material-icons">calendar_today</span>
    <h2> {{ getMonthName() }} {{ year }}</h2>

    <button (click)="nextMonth()">&#62;</button>
  </div>

  <!-- ===== Modern Status Cards ===== -->
  <div class="status-cards-modern" *ngIf="!isAdmin">
    <div class="status-card pending">
      <div class="icon"><mat-icon>hourglass_empty</mat-icon></div>
      <div class="content">
        <h3>Pending</h3>
        <p>{{ getCount('pending') }} / {{ totalRequests }}</p>
        <div class="progress-container">
          <div class="progress" [style.width.%]="getProgress('pending')"></div>
        </div>
        <span class="percent">{{ getProgress('pending') }}%</span>
      </div>
    </div>

    <div class="status-card approved">
      <div class="icon"><mat-icon>check_circle</mat-icon></div>
      <div class="content">
        <h3>Approved</h3>
        <p>{{ getCount('approved') }} / {{ totalRequests }}</p>
        <div class="progress-container">
          <div class="progress" [style.width.%]="getProgress('approved')"></div>
        </div>
        <span class="percent">{{ getProgress('approved') }}%</span>
      </div>
    </div>

    <div class="status-card rejected">
      <div class="icon"><mat-icon>cancel</mat-icon></div>
      <div class="content">
        <h3>Rejected</h3>
        <p>{{ getCount('rejected') }} / {{ totalRequests }}</p>
        <div class="progress-container">
          <div class="progress" [style.width.%]="getProgress('rejected')"></div>
        </div>
        <span class="percent">{{ getProgress('rejected') }}%</span>
      </div>
    </div>
  </div>


  <!-- ===== Details Table ===== -->
  <!-- ===== Banner ===== -->
  <div class="banner">
    <h2>Work From Home Details</h2>
  </div>

  <!-- ===== WFH Details Table ===== -->
  <div class="table-container">
    <table class="details-table">
      <thead>
        <tr>
          <th>Request Id</th>
          <th>Employee Id</th>
          <th>Employee Name</th>
          <th>Employee Email</th>
          <th>Date Range</th>
          <th>Days</th>
          <th>Reason</th>
          <th>Approver</th>
          <th>Status</th>
          <th *ngIf="isAdmin">Action</th>
        </tr>
      </thead>
      <tbody *ngIf="approvalDetails && approvalDetails.length > 0; else noRequests">
        <tr *ngFor="let d of approvalDetails">
          <td data-label="Request Id">{{ d.requestId }}</td>
          <td data-label="Employee Id">{{ d.employeeId }}</td>
          <td data-label="Employee Name">{{ d.employeeName }}</td>
          <td data-label="Employee Email">{{ d.employeeEmail }}</td>
          <td data-label="Date Range">{{ d.fromNextDay | date:'dd/MM/yyyy' }} - {{ d.toNextDay | date:'dd/MM/yyyy' }}</td>
          <td data-label="Days">{{ d.days }}</td>
          <td data-label="Reason">{{ d.reason }}</td>
          <td data-label="Approver">{{ d.approver }}</td>
          <td data-label="Status" [ngClass]="{
              'approved-status': d.status === 'approved',
              'rejected-status': d.status === 'rejected',
              'pending-status': d.status === 'pending'
            }">
            {{ d.status | titlecase }}
          </td>
          <td *ngIf="isAdmin" data-label="Action" class="actions">
            <!-- <button (click)="updateStatus(d, 'approved')">✔</button>
          <button (click)="updateStatus(d, 'rejected')">❌</button> -->

            <!-- APPROVE BUTTON -->
            <button mat-raised-button color="primary"
              [disabled]="loadingStatus[d.requestId] === 'approve' || loadingStatus[d.requestId] === 'reject'"
              (click)="updateStatus(d, 'approved')">
              <ng-container *ngIf="loadingStatus[d.requestId] === 'approve'; else approveText">
                <mat-spinner diameter="20" strokeWidth="3" class="approve-spinner"></mat-spinner>
              </ng-container>
              <ng-template #approveText>✔</ng-template>
            </button>

            <!-- REJECT BUTTON -->
            <button mat-raised-button color="warn"
              [disabled]="loadingStatus[d.requestId] === 'approve' || loadingStatus[d.requestId] === 'reject'"
              (click)="updateStatus(d, 'rejected')">
              <ng-container *ngIf="loadingStatus[d.requestId] === 'reject'; else rejectText">
                <mat-spinner diameter="20" strokeWidth="3" class="reject-spinner"></mat-spinner>
              </ng-container>
              <ng-template #rejectText>❌</ng-template>
            </button>

          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- ===== Month Navigation ===== -->
  <div *ngIf="isAdmin" class="month-nav">
    <button (click)="prevMonth()">&#60;</button>
    <span class="calendar-icon material-icons">calendar_today</span>
    <h2>{{ getMonthName() }} {{ year }}</h2>
    <button (click)="nextMonth()">&#62;</button>
  </div>

  <!-- ===== Approved Requests Table (Admin Only) ===== -->
  <div *ngIf="isAdmin" class="approved-table">
    <h3>Approved Work From Home Requests</h3>

    <table class="approval-details-table">
      <thead>
        <tr>
          <th>Request Id</th>
          <th>Employee Id</th>
          <th>Employee Name</th>
          <th>Employee Email</th>
          <th>Date Range</th>
          <th>Days</th>
          <th>Reason</th>
          <th>Approver</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody *ngIf="approvedRequests && approvedRequests.length > 0; else noApproved">
        <tr *ngFor="let d of approvedRequests">
          <td data-label="Request Id">{{ d.requestId }}</td>
          <td data-label="Employee Id">{{ d.employeeId }}</td>
          <td data-label="Employee Name">{{ d.employeeName }}</td>
          <td data-label="Employee Email">{{ d.employeeEmail }}</td>
          <td data-label="Date Range">  {{ d.fromNextDay | date:'dd/MM/yyyy' }} - {{ d.toNextDay | date:'dd/MM/yyyy' }}</td>
          <td data-label="Days">{{ d.days }}</td>
          <td data-label="Reason">{{ d.reason }}</td>
          <td data-label="Approver">{{ d.approver }}</td>
          <td data-label="Status" class="approved-status">{{ d.status | titlecase }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- ===== Templates ===== -->
  <!-- ===== Empty State Templates ===== -->
  <ng-template #noRequests>
    <tbody>
      <tr>
        <td [attr.colspan]="isAdmin ? 10 : 9" class="no-data">
          No requests available.
        </td>
      </tr>
    </tbody>
  </ng-template>

  <ng-template #noApproved>
    <tbody>
      <tr>
        <td [attr.colspan]="isAdmin ? 10 : 9" class="no-data">
          No approved requests available.
        </td>
      </tr>
    </tbody>
  </ng-template>